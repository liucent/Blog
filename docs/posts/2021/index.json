[
    {
        "ref": "https://www.ariesme.com/posts/2021/nginx_proxy_for_cdnjs_and_fonts/",
        "title": "Nginx反代cdnjs和fonts",
        "section": "posts",
        "tags": ["nginx","proxy","cdnjs","fonts"],
        "date" : "2021.03.26",
        "body": "最近有点不想用公共cdn, 于是就着手用自己手头的VPS里的Nginx反代Cloudflare cdnjs和Google fonts. 方法其实并不难, 特别是服务器上已经有Nginx环境的.\n首先，毕竟是要用https的，所以准备好自己的域名以及ssl证书. 这里假设用cdnjs.yours.com反代cdnjs.cloudflare.com, 用fonts.yours.com反代fonts.googleapis.com和fonts.gstatic.com. 其中fonts.googleapis.com是返回各个字体的css文件, fonts.gstatic.com则是css文件里面标识的下载单个字体文件的域名.\n1. Nginx反代cdnjs 假设ssl证书都已经设置好了, 在nginx的配置文件里的http结构添加cache信息, 如果没有http结构则只需添加在server结构外即可.\n# cache路径, 过期时间, 最大大小 proxy_cache_path /home/wwwroot/cdnjs.yours.com levels=1:2 keys_zone=cache_cdnjs:20m inactive=1d max_size=100m; 在server结构里添加location反代设置.\nlocation / { # 设置referers白名单, 只有*.yours.com发过来的请求才会做反代, 其余请求直接返回403  valid_referers none blocked server_names *.yours.com ; if ($invalid_referer) { return 403; } proxy_pass_header Server; proxy_set_header Host cdnjs.cloudflare.com; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; proxy_pass https://cdnjs.cloudflare.com; proxy_cache cache_cdnjs; # cache过期时间1天  proxy_cache_valid 200 304 1d; proxy_cache_key $host$uri$is_args$args; expires 1d; } 2. Nginx反代fonts 在nginx的配置文件里的http结构添加cache信息, 如果没有http结构则只需添加在server结构外即可.\n# cache路径, 过期时间, 最大大小 proxy_cache_path /home/wwwroot/fonts.yours.com levels=1:2 keys_zone=cache_fonts:20m inactive=1d max_size=100m; 反代Google fonts会稍微麻烦点. 因为字体请求流程是这样的:\n 发送请求到fonts.googleapis.com/css, Google会返回一个css文件. 文件里包含不同字号大小的字体文件路径url(fonts.gstatic.com). 根据不同字号大小的url请求相应的单字体文件.  由此可见我们不仅先要反代请求到fonts.googleapis.com还要把返回的css文件里的fonts.gstatic.com全部替换为我们自己的域名fonts.yours.com.\n在server结构里添加location反代设置.\n# 反代字体请求发到fonts.googleapis.com location /css { valid_referers none blocked server_names *.yours.com ; if ($invalid_referer) { return 403; } # 将返回的css文件里的fonts.gstatic.com替换成自己的域名fonts.yours.com  sub_filter \u0026#39;fonts.gstatic.com\u0026#39; \u0026#39;fonts.yours.com\u0026#39;; sub_filter_once off; sub_filter_types text/css; proxy_pass_header Server; proxy_set_header Host fonts.googleapis.com; proxy_set_header Accept-Encoding \u0026#39;\u0026#39;; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; proxy_pass https://fonts.googleapis.com; proxy_cache cache_fonts; proxy_cache_valid 200 304 1d; proxy_cache_key $host$uri$is_args$args; expires 1d; } location /icon { valid_referers none blocked server_names *.yours.com ; if ($invalid_referer) { return 403; } sub_filter \u0026#39;fonts.gstatic.com\u0026#39; \u0026#39;fonts.yours.com\u0026#39;; sub_filter_once off; sub_filter_types text/css; proxy_pass_header Server; proxy_set_header Host fonts.googleapis.com; proxy_set_header Accept-Encoding \u0026#39;\u0026#39;; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; proxy_pass https://fonts.googleapis.com; proxy_cache cache_fonts; proxy_cache_valid 200 304 1d; proxy_cache_key $host$uri$is_args$args; expires 1d; } # 反代单个字体文件请求到fonts.gstatic.com location / { valid_referers none blocked server_names *.yours.com ; if ($invalid_referer) { return 403; } proxy_pass_header Server; proxy_set_header Host fonts.gstatic.com; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Scheme $scheme; proxy_pass https://fonts.gstatic.com; proxy_cache cache_fonts; proxy_cache_valid 200 304 1d; proxy_cache_key $host$uri$is_args$args; expires 1d; } 3. 更新历史    Version Detail Date     1.0 初版 2021-03-26   1.1 修改错误 2021-03-27   "
    }
]